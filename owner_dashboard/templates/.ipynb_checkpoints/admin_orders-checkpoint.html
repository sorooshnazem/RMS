<!DOCTYPE html>
<html>
<head>
    <title>Live Orders Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ccc;
            text-align: left;
        }
        tr:hover:not(.order-details) {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        .order-details td {
            background-color: #f9f9f9;
            padding: 15px;
            font-size: 14px;
        }
        .status-btn {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            display: inline-block;
        }

        .status-pending {
            background-color: #f0ad4e; /* orange */
        }

        .status-confirmed {
            background-color: #5cb85c; /* green */
        }

        .status-rejected {
            background-color: #d9534f; /* red */
        }

    </style>
</head>
<body>

<h1>Live Incoming Orders</h1>

<table id="orders-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Time</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <!-- Orders will be dynamically inserted here -->
    </tbody>
</table>

<script>
    async function fetchOrders() {
        const res = await fetch('/api/orders');
        const orders = await res.json();
        const tbody = document.querySelector('#orders-table tbody');
        tbody.innerHTML = '';

        orders.forEach(order => {
            const row = document.createElement('tr');

            // Normalize status case for comparison
            const isPending = order.gn_order_status_name?.toLowerCase() === 'pending';

            const statusHTML = isPending
                ? `
                    <button class="status-btn" onclick="event.stopPropagation(); updateStatus(${order.id_order_id}, 'Confirmed')">Confirm</button>
                    <button class="status-btn" onclick="event.stopPropagation(); updateStatus(${order.id_order_id}, 'Rejected')">Reject</button>
                  `
                : order.gn_order_status_name;

            row.innerHTML = `
                <td>${order.id_order_id}</td>
                <td>${order.gn_full_name}</td>
                <td>${order.nm_phone_number}</td>
                <td>${order.dt_order_date}</td>
                <td>${statusHTML}</td>
            `;

            row.addEventListener('click', () => toggleDetails(order.id_order_id));
            tbody.appendChild(row);

            const detailRow = document.createElement('tr');
            detailRow.classList.add('order-details');
            detailRow.style.display = 'none';
            detailRow.id = `details-${order.id_order_id}`;
            detailRow.innerHTML = `<td colspan="5">Loading...</td>`;
            tbody.appendChild(detailRow);
        });
    }

    async function toggleDetails(orderId) {
        const detailRow = document.getElementById(`details-${orderId}`);
        if (!detailRow) return;

        const isVisible = detailRow.style.display !== 'none';
        if (isVisible) {
            detailRow.style.display = 'none';
            return;
        }

        const res = await fetch(`/api/orders/${orderId}`);
        const data = await res.json();

        if (data.error) {
            detailRow.innerHTML = `<td colspan="5"><em>${data.error}</em></td>`;
        } else {
            const itemsHtml = data.items.map(item => `
                <li><strong>${item.gn_food_name}</strong> – €${item.nm_price_number}<br><em>${item.ds_food_descr}</em></li>
            `).join('');

            detailRow.innerHTML = `<td colspan="5">
                <strong>Order Details:</strong>
                <ul>${itemsHtml}</ul>
            </td>`;
        }

        detailRow.style.display = '';
    }

    async function updateStatus(orderId, status) {
        const res = await fetch(`/api/orders/${orderId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });

        const result = await res.json();
        if (result.success) {
            fetchOrders(); // Refresh table
        } else {
            alert(result.error || 'Failed to update order status.');
        }
    }

    fetchOrders();
    setInterval(fetchOrders, 10000); // Auto-refresh every 10s
</script>

</body>
</html>
